<html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Aeolian Eye</title>
    <!-- Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.8/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.8/addons/p5.dom.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
  <style>
    #map {
      margin: auto;
      width: 90%;
      height: 65%;;
    }
  </style>
</head>
  </head>
<style type="text/css">
#main{
  position: relative;
}
#video{
  position: absolute;
  top:50%;
  transform: translate(0, -50%);
}
#demo{
  padding:0 5em 0 5em;
	float:left;
}
.input-group{
  padding-right:5em;
  padding-left:5em;
}
h1 {
    position: relative;
    text-align: center;
    /*background-image: url("static/logo.png");*/
}
</style>
  <body>
    <h1>Aeolian Eye</h1>
    <div id="main">
    	<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="true">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" id="refre">Aeolian</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="active"><a href="https://aeolianair.com/map">Map<span class="sr-only">(current)</span></a></li>
        <li ><a href="https://aeolianair.com/butler"> Butler </a></li>
        <li ><a href="https://aeolianair.com/mirror">Reality</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Hi Xiaoyue! <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="#">My Account</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="https://aeolianair.com/help">Help</a></li>
          </ul>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
    </div>
<div id='demo'></div>
<div class="input-group">
  <input id= "address" type="text" class="form-control" placeholder="Shanghai" aria-describedby="basic-addon2">
  <span class="input-group-addon" id="basic-addon2">Search</span>
</div>
<div id='map'></div>
<script>
   var map;
     var marker;
  var lat = 40;
  var lng = 40;
  var greenIcon;
  var orangeIcon;
  var yellowIcon;
  var pikachuIc;
  var LeafIcon;
  var x = document.getElementById("demo");
  function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
  }
   function showPosition(position) {
      x.innerHTML = "Current Latitude: " + position.coords.latitude + 
      "<br>Current Longitude: " + position.coords.longitude;
      lat = position.coords.latitude;
      lng = position.coords.longitude;
      console.log("after lat", lat, "lng" ,lng);
	   map = L.map('map').setView([lat, lng], 13);
      // alert(lat);
      tiles = L.tileLayer('https\://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    LeafIcon = L.Icon.extend({
      options: {
        shadowUrl: '',
        iconSize:     [60, 60],
        iconAnchor:   [30, 50],
        popupAnchor:  [-3, -76]
      }
    });
    greenIcon = new LeafIcon({iconUrl: 'static/Bulbasaur.png'});
      yellowIcon = new LeafIcon({iconUrl: 'static/Muk1.png'});
      orangeIcon = new LeafIcon({iconUrl: 'static/Gastly.png'});
	pikachuIc = new LeafIcon({iconUrl:'static/Pikachu.png'});
  koffIc = new LeafIcon({iconUrl:'static/Koffing.png'});
	L.marker([32.233501,121.412540], {icon: pikachuIc}).bindPopup("Good Air at Global Harbor").addTo(map);
    L.marker([lat-0.008, lng-0.089], {icon: yellowIcon}).bindPopup("Some Air Pollution at Prince Mall").addTo(map);
    L.marker([lat-0.035, lng+0.007], {icon: orangeIcon}).bindPopup("Hazardous Air at Mr.Barbecue").addTo(map);
        L.marker([lat+0.015, lng-0.027], {icon: koffIc}).bindPopup("Combustible Gas concentration at Babaiban Mall").addTo(map);
        L.marker([lat+0.025, lng+0.003], {icon: orangeIcon}).bindPopup("Some Air Pollution at IFC Cinema").addTo(map);
       L.marker([lat-0.215, lng-3.027], {icon: koffIc}).bindPopup("Combustible Gas concentration at Chongqing Hotpot").addTo(map);
       L.marker([lat-0.01, lng-0.04], {icon: greenIcon}).bindPopup("Clean Air at Oriental Pearl TV Tower").addTo(map);
       L.marker([lat-0.1, lng+0.1], {icon: greenIcon}).bindPopup("Clean Air at Shanghai Art Gallery").addTo(map);
     marker = new L.marker([lat, lng], {icon: greenIcon}).bindPopup("Clean Air at NYU Shanghai").addTo(map);

  }
  window.onload = function() {
        getLocation();
    }
  function initMap() {
        var geocoder = new google.maps.Geocoder();

        document.getElementById("basic-addon2").addEventListener('click', function() {
          geocodeAddress(geocoder, map);
        });
      }
      function geocodeAddress(geocoder, resultsMap) {
        var address = document.getElementById('address').value;
        geocoder.geocode({'address': address}, function(results, status) {
          if (status === 'OK') {
            console.log("results"+results[0].geometry.location.lat());
            var newlat = results[0].geometry.location.lat();
            var newlng = results[0].geometry.location.lng();
            map.setView([newlat, newlng],13);
           // resultsMap.setCenter(results[0].geometry.location);
          } else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
      }

  var console_data = function(e) {
    $.get('/data', function (newdata) {
      var newresults = newdata['results'];
      //console.log(newdata);
      //console.log("latest");
      //console.log(newresults[newresults.length-1].data);
console.log("latest"+newresults[newresults.length-1].data);
if(newresults[newresults.length-1].data<130){
  marker.setIcon(greenIcon);
marker.setPopupContent( "Clean Air at NYU Shanghai: " +newresults[newresults.length-1].data );
}else{
  //tiles.redraw();
marker.setIcon( orangeIcon);
marker.setPopupContent( "Hazardous Air at NYU Shanghai: "+ newresults[newresults.length-1].data );
}
    //console.log(newdata[newdata.length-1].data);
      // for(i = 0; i <  newdata[newdata.length-1].data -100; i = i + 3){
      //   bulbasaurArr.push(new newBulbasaur());
      //   bulbasaurArr.push(new newBulbasaur());
      //   bulbasaurArr.push(new newBulbasaur());
        //gastlyArr.push(new newGastly());
      //}
    });
  }
  setInterval(function () {console_data();}, 500);

  $(function() {
    console_data();
    $('#refre').bind('click', console_data());
  });
  // setInterval(function () {console.log(1234);}, 100);
    </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD577pkBRsSInQfUBqIjERhWFixdt4FEqw&callback=initMap">
    </script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  </div>
  </body>
</html>

